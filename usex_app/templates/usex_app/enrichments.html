{% extends "usex_app/index.html" %}
{% block title %}
Enrichment - Matcha
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Enrichment for {{ datasource.name }}</h2>
    <p><strong>Description:</strong> {{ datasource.description }}</p>
    <p><strong>Type:</strong> {{ datasource.datasource_type }}</p>

    <!-- Get Input Schema Button -->
    <div class="mb-4">
        <button id="get-input-schema" class="btn btn-primary">Get Input Schema</button>
    </div>

    <div class="row mt-4">
        <!-- Query Result Columns -->
        <div class="col-md-3">
            <h4>Query Result Columns</h4>
            <ul id="query-columns" class="list-group">
                <!-- Dynamically populated list of columns -->
            </ul>
        </div>

        <!-- Column Data Types -->
        <div class="col-md-3">
            <h4>Column Data Types</h4>
            <ul id="column-datatypes" class="list-group">
                <!-- Dynamically populated list of column data types -->
            </ul>
        </div>

        <!-- First Record Values -->
        <div class="col-md-3">
            <h4>Sampled Values</h4>
            <ul id="first-record-values" class="list-group">
                <!-- Dynamically populated list of first record values -->
            </ul>
        </div>

        <!-- Created Fields -->
        <div class="col-md-3">
            <h4>Created Fields</h4>
            <ul id="created-fields" class="list-group">
                <!-- Dynamically populated list of created fields -->
            </ul>
            <button id="add-calculated-field" class="btn btn-success mt-3">Create Calculated Field</button>
        </div>
    </div>
</div>

<!-- Modal for Creating Calculated Fields -->
<div class="modal fade" id="calculatedFieldModal" tabindex="-1" aria-labelledby="calculatedFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calculatedFieldModalLabel">Create Calculated Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="calculated-field-form">
                    <div class="mb-3">
                        <label for="field-name" class="form-label">Field Name</label>
                        <input type="text" id="field-name" class="form-control" placeholder="Enter field name" required>
                    </div>
                    <div class="mb-3">
                        <label for="field-expression" class="form-label">Field Expression</label>
                        <textarea id="field-expression" class="form-control" rows="3" placeholder="Drag and drop column names here or type manually" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="save-calculated-field" class="btn btn-primary">Save Field</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const queryColumns = document.getElementById('query-columns');
        const columnDatatypes = document.getElementById('column-datatypes');
        const firstRecordValues = document.getElementById('first-record-values');
        const createdFields = document.getElementById('created-fields');
        const getInputSchemaButton = document.getElementById('get-input-schema');
        const addCalculatedFieldButton = document.getElementById('add-calculated-field');
        const calculatedFieldModal = new bootstrap.Modal(document.getElementById('calculatedFieldModal'));
        const saveCalculatedFieldButton = document.getElementById('save-calculated-field');
        const fieldNameInput = document.getElementById('field-name');
        const fieldExpressionInput = document.getElementById('field-expression');

        // Function to fetch query dataset from the backend
        async function fetchQueryDataset() {
            try {
                const response = await fetch("{% url 'fetch_query_dataset' datasource.id %}", {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.statusText}`);
                }

                const data = await response.json();
                if (data.success) {
                    return data; // Return the dataset
                } else {
                    alert(`Error: ${data.error}`);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching query dataset:', error);
                alert('Failed to fetch query dataset. Please try again.');
                return null;
            }
        }

        // Handle "Get Input Schema" button click
        getInputSchemaButton.addEventListener('click', async function () {
            // Fetch query dataset
            const dataset = await fetchQueryDataset();

            if (!dataset) return;

            // Populate the query columns list
            queryColumns.innerHTML = '';
            dataset.columns.forEach(column => {
                const li = document.createElement('li');
                li.className = 'list-group-item draggable';
                li.textContent = column;
                li.draggable = true;

                // Add drag-and-drop functionality
                li.addEventListener('dragstart', function (event) {
                    event.dataTransfer.setData('text/plain', column);
                });

                queryColumns.appendChild(li);
            });

            // Populate the column data types list
            columnDatatypes.innerHTML = '';
            dataset.column_datatypes.forEach((datatype, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${dataset.columns[index]}: ${datatype}`;
                columnDatatypes.appendChild(li);
            });

            // Populate the first record values list
            firstRecordValues.innerHTML = '';
            dataset.first_record.forEach(value => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = value;
                firstRecordValues.appendChild(li);
            });
        });

        // Enable drag-and-drop for the field expression textarea
        fieldExpressionInput.addEventListener('dragover', function (event) {
            event.preventDefault();
        });

        fieldExpressionInput.addEventListener('drop', function (event) {
            event.preventDefault();
            const droppedText = event.dataTransfer.getData('text/plain');
            fieldExpressionInput.value += droppedText;
        });

        // Handle "Add Calculated Field" button click
        addCalculatedFieldButton.addEventListener('click', function () {
            fieldNameInput.value = '';
            fieldExpressionInput.value = '';
            calculatedFieldModal.show();
        });

        // Handle "Save Calculated Field" button click
        saveCalculatedFieldButton.addEventListener('click', function () {
            const fieldName = fieldNameInput.value.trim();
            const fieldExpression = fieldExpressionInput.value.trim();

            if (!fieldName || !fieldExpression) {
                alert('Both field name and expression are required.');
                return;
            }

            // Add the new field to the created fields list
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${fieldName}: ${fieldExpression}`;
            createdFields.appendChild(li);

            calculatedFieldModal.hide();
        });
    });
</script>
{% endblock %}