{% extends 'usex_app/index.html' %}
{% block style %}
<!-- Select2 CSS -->
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
 {% endblock %}

{% block content %}
<!-- Modal for selecting datasource -->
<div
  class="modal fade"
  id="selectDatasourceModal"
  tabindex="-1"
  aria-labelledby="selectDatasourceModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="selectDatasourceModalLabel">
          Select Datasource
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <select id="datasourceSelect" class="form-select">
          <option value="" disabled selected>Select a datasource</option>
          {% for datasource in datasources %}
          <option value="{{ datasource.id }}">{{ datasource.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-primary"
          id="selectDatasourceButton"
        >
          Select
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Div for creating profile template -->

<!-- Div for creating profile template -->
<div id="profileTemplateDiv" class="mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h5>Profile Filter</h5>
    <button class="btn btn-primary btn-sm" id="addProfileFilterButton">
      Add Profile Filter
    </button>
  </div>
  <div
    id="profileTemplateContainer"
    class="mt-2 border p-3"
    style="min-height: 100px; background-color: #f8f9fa"
  >
    <!-- Selected filter templates will be dynamically added here -->
  </div>
</div>

<!-- Div for creating trigger event template -->
<div id="triggerEventTemplateDiv" class="mt-4">
  <!-- Trigger Event Button -->
  <div class="d-flex justify-content-between align-items-center">
    <h5>Trigger Events</h5>
    <button class="btn btn-primary btn-sm" id="addTriggerEventButton">
      Add Trigger Event
    </button>
  </div>
  <div
    id="triggerEventContainer"
    class="mt-2 border p-3"
    style="min-height: 100px; background-color: #f8f9fa"
  >
    <!-- Trigger events will be dynamically added here -->
  </div>
  <!-- Trigger Actions Div -->
<div id="triggerActionsDiv" class="mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h5>Trigger Actions</h5>
    <button class="btn btn-primary btn-sm" id="addTriggerActionButton">
      Add Trigger Action
    </button>
  </div>
  <div
    id="triggerActionsContainer"
    class="mt-2 border p-3"
    style="min-height: 100px; background-color: #f8f9fa"
  >
    <!-- Trigger actions will be dynamically added here -->
  </div>
</div>
  <!-- Div for setting contact policy -->
  <div id="contactPolicyAndLimitsDiv" class="d-flex mt-4">
    <!-- Contact Policy Div (60%) -->
    <div id="contactPolicyDiv" class="flex-grow-1 me-4" style="width: 60%;">
      <h5>Contact Policy</h5>
      <form id="contactPolicyForm">
        <div class="row mb-3">
          <div class="col-1"><strong>Select</strong></div>
          <div class="col-2"><strong>Day</strong></div>
          <div class="col-4"><strong>From Time</strong></div>
          <div class="col-4"><strong>To Time</strong></div>
        </div>
        {% for day in days_list %}
        <div class="row mb-2 align-items-center">
          <div class="col-1">
            <input
              type="checkbox"
              id="{{ day|lower }}Checkbox"
              name="{{ day|lower }}Checkbox"
              class="form-check-input"
              checked
            />
          </div>
          <div class="col-2">
            <label for="{{ day|lower }}FromTime">{{ day }}</label>
          </div>
          <div class="col-4">
            <input
              type="time"
              id="{{ day|lower }}FromTime"
              name="{{ day|lower }}FromTime"
              class="form-control"
            />
          </div>
          <div class="col-4">
            <input
              type="time"
              id="{{ day|lower }}ToTime"
              name="{{ day|lower }}ToTime"
              class="form-control"
            />
          </div>
        </div>
        {% endfor %}
        <button
          type="button"
          class="btn btn-success mt-3"
          id="saveContactPolicyButton"
        >
          Save Contact Policy
        </button>
      </form>
    </div>
  
    <!-- Campaign and User Limits Div (40%) -->
    <div id="limitsDiv" class="flex-shrink-1" style="width: 40%;">
      <h5>Limits</h5>
      <form id="limitsForm">
        <div class="mb-3">
          <label for="campaignLimit" class="form-label">Per Campaign</label>
          <div class="d-flex align-items-center">
            <input
              type="number"
              id="campaignLimit"
              name="campaignLimit"
              class="form-control me-2"
              placeholder="Enter limit"
            />
            <span>per</span>
            <input
              type="number"
              id="campaignPeriod"
              name="campaignPeriod"
              class="form-control ms-2 me-2"
              placeholder="Enter period"
            />
            <select id="campaignPeriodUnit" name="campaignPeriodUnit" class="form-select">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label for="userLimit" class="form-label">Per User</label>
          <div class="d-flex align-items-center">
            <input
              type="number"
              id="userLimit"
              name="userLimit"
              class="form-control me-2"
              placeholder="Enter limit"
            />
            <span>per</span>
            <input
              type="number"
              id="userPeriod"
              name="userPeriod"
              class="form-control ms-2 me-2"
              placeholder="Enter period"
            />
            <select id="userPeriodUnit" name="userPeriodUnit" class="form-select">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
            </select>
          </div>
        </div>
        <button
          type="button"
          class="btn btn-success mt-3"
          id="saveLimitsButton"
        >
          Save Limits
        </button>
      </form>
    </div>
  </div>

  <!-- Save button -->
  <div class="mt-4">
    <button
      class="btn btn-success"
      id="saveCampaignButton"
      style="display: none"
    >
      Save Campaign
    </button>
  </div>
  <!-- Modal for selecting trigger event templates -->
  <div
    class="modal fade"
    id="selectTriggerEventModal"
    tabindex="-1"
    aria-labelledby="selectTriggerEventModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="selectTriggerEventModalLabel">
            Select Trigger Event Template
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <ul id="triggerEventTemplatesList" class="list-group">
            <!-- Templates will be dynamically populated here -->
          </ul>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            id="selectTriggerEventButton"
          >
            Select
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal for selecting profile filter templates -->
  <div
    class="modal fade"
    id="selectProfileFilterModal"
    tabindex="-1"
    aria-labelledby="selectProfileFilterModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="selectProfileFilterModalLabel">
            Select Profile Filter Template
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <ul id="profileFilterTemplatesList" class="list-group">
            <!-- Templates will be dynamically populated here -->
          </ul>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            id="selectProfileFilterButton"
          >
            Select
          </button>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const datasourceSelect = document.getElementById("datasourceSelect");
      const selectDatasourceButton = document.getElementById(
        "selectDatasourceButton"
      );
      const profileTemplateDiv = document.getElementById("profileTemplateDiv");
      const triggerEventTemplateDiv = document.getElementById(
        "triggerEventTemplateDiv"
      );
      const contactPolicyDiv = document.getElementById("contactPolicyDiv");
      const saveCampaignButton = document.getElementById("saveCampaignButton");

      // Show the "Select Datasource" modal on page load
      const selectDatasourceModal = new bootstrap.Modal(
        document.getElementById("selectDatasourceModal")
      );
      selectDatasourceModal.show();
      
      // Handle datasource selection
      selectDatasourceButton.addEventListener("click", function () {
        const selectedDatasourceId = datasourceSelect.value;
        if (!selectedDatasourceId) {
          alert("Please select a datasource.");
          return;
        }

        // Close the modal
        selectDatasourceModal.hide();

        // Show profile template div
        profileTemplateDiv.style.display = "block";
      });

      // Handle profile template selection
      document
        .getElementById("addProfileFilterButton")
        .addEventListener("click", function () {
          triggerEventTemplateDiv.style.display = "block";
        });

      // Handle trigger event template selection
      document
        .getElementById("addTriggerEventButton")
        .addEventListener("click", function () {
          contactPolicyDiv.style.display = "block";
        });

      // Show save button when contact policy is set
      document
        .getElementById("contactPolicy")
        .addEventListener("input", function () {
          saveCampaignButton.style.display = "block";
        });

      // Handle save campaign
      saveCampaignButton.addEventListener("click", async function () {
        const datasourceId = datasourceSelect.value;
        const profileTemplateExpression = document.getElementById(
          "profileTemplateExpression"
        ).value;
        const eventTemplateExpression = document.getElementById(
          "eventTemplateExpression"
        ).value;
        const contactPolicy = document.getElementById("contactPolicy").value;

        if (
          !datasourceId ||
          !profileTemplateExpression ||
          !eventTemplateExpression ||
          !contactPolicy
        ) {
          alert("Please fill out all fields.");
          return;
        }

        const campaignData = {
          datasource_id: datasourceId,
          profile_template_expression: profileTemplateExpression,
          event_template_expression: eventTemplateExpression,
          contact_policy: contactPolicy,
        };

        try {
          const response = await fetch("/api/create_campaign/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify(campaignData),
          });

          if (!response.ok) {
            throw new Error("Failed to save campaign.");
          }

          const data = await response.json();
          if (data.success) {
            alert("Campaign created successfully!");
            window.location.href = "/campaigns/";
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error saving campaign:", error);
          alert("Failed to save campaign.");
        }
      });
    });
    document.addEventListener("DOMContentLoaded", function () {
      const datasourceSelect = document.getElementById("datasourceSelect");
      const addProfileFilterButton = document.getElementById(
        "addProfileFilterButton"
      );
      const profileFilterTemplatesList = document.getElementById(
        "profileFilterTemplatesList"
      );
      const selectProfileFilterModal = new bootstrap.Modal(
        document.getElementById("selectProfileFilterModal")
      );
      const selectProfileFilterButton = document.getElementById(
        "selectProfileFilterButton"
      );
      const profileTemplateContainer = document.getElementById(
        "profileTemplateContainer"
      );
      let selectionDict = {}; // Dictionary to store operators and enums for each templateID
      // Function to fetch operators and enums by templateID
      async function fetchOperatorsAndEnumsByTemplateID(templateID) {
        try {
          const response = await fetch(
            `/api/get_operators_and_enums_by_templateID/${templateID}/`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch operators and enums.");
          }

          const data = await response.json();
          if (data.success) {
            console.debug(data);
            selectionDict = data.operators_and_enums;
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error fetching operators and enums:", error);
          alert("Failed to fetch operators and enums.");
        }
      }
      // Handle "Add Profile Filter" button click
      addProfileFilterButton.addEventListener("click", async function () {
        const selectedDatasourceId = datasourceSelect.value;
        if (!selectedDatasourceId) {
          alert("Please select a datasource first.");
          return;
        }

        // Fetch templates from the backend
        try {
          const response = await fetch(
            `/api/profile-templates-for-datasource/${selectedDatasourceId}/`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch templates.");
          }

          const data = await response.json();
          if (data.success) {
            // Clear existing templates
            profileFilterTemplatesList.innerHTML = "";

            // Populate templates in the modal
            data.templates.forEach((template) => {
              if (
                template.expression.includes("profile") &&
                !template.expression.includes("feed")
              ) {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.dataset.templateId = template.id;
                li.dataset.expression = template.expression;
                li.dataset.displayText = template.display_text;

                li.textContent = template.name;
                profileFilterTemplatesList.appendChild(li);
              }
            });

            // Show the modal
            selectProfileFilterModal.show();
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error fetching templates:", error);
          alert("Failed to fetch templates.");
        }
      });
      function generateHash() {
        const timestamp = Date.now(); // Get the current timestamp
        const randomNumber = Math.floor(Math.random() * 100000); // Generate a random number between 0 and 99999
        const hash = (timestamp + randomNumber) % 100000; // Combine timestamp and random number, limit to 5 digits
        return hash.toString().padStart(5, "0"); // Ensure it's always 5 digits
      }
      // Handle template selection in the modal
      selectProfileFilterButton.addEventListener("click", async function () {
        const selectedTemplate = profileFilterTemplatesList.querySelector(
          ".list-group-item.active"
        );
        if (!selectedTemplate) {
          alert("Please select a template.");
          return;
        }
        // Get operators and enums from the selected template
        templateID = selectedTemplate.dataset.templateId;
        await fetchOperatorsAndEnumsByTemplateID(templateID);
        const uniqueFilterId = `filter_${generateHash()}`;
        // Create a new div for the selected template
        const filterDiv = document.createElement("div");
        filterDiv.className = "  mb-2";
        filterDiv.dataset.templateId = selectedTemplate.dataset.templateId;
        filterDiv.dataset.expression = selectedTemplate.dataset.expression;
        filterDiv.id = uniqueFilterId; // Assign the unique identifier
        const displayText = selectedTemplate.dataset.displayText;

        // Replace selection placeholders with dropdowns
        const updatedDisplayText = displayText.replace(
          /\$selection\_(\w+)/g,
          function (match, selectionKey) {
            console.debug("Processing selection key:", selectionKey);

            console.debug("Match", match);
            const select = document.createElement("select");
            select.className = "form-select form-select-sm me-2";
            select.style.width = "auto";
            const container = document.createElement("span"); // Use a span to group elements
            container.style.display = "inline-flex"; // Ensure elements appear together
            select.name = match; // Use the match variable as the name
            select.id = `${uniqueFilterId}_${match}`; // Create a unique ID using the filter ID and match

            // Add the display text

            if (selectionDict[match]) {
              for (const option_item of selectionDict[match]["options"]) {
                const option = document.createElement("option");
                option.value = option_item.key;
                option.textContent = option_item.display_name;
                select.appendChild(option);
              }
            } else {
              console.warn(
                `No options found for selection key: ${selectionKey}`
              );
              const option = document.createElement("option");
              option.value = "";
              option.textContent = "No options available";
              select.appendChild(option);
            }

            container.appendChild(select);
            return container.outerHTML; // Return the container's HTML
          }
        );

        // Add the updated display text to the div
        filterDiv.innerHTML = updatedDisplayText;

        // Add a delete button to remove the filter
        const deleteButton = document.createElement("button");
        deleteButton.className = "btn-close";
        deleteButton.addEventListener("click", function () {
          filterDiv.remove();
        });

        filterDiv.appendChild(deleteButton);
        profileTemplateContainer.appendChild(filterDiv);

        // Close the modal
        selectProfileFilterModal.hide();
      });

      // Add click event listener to list items for selection
      profileFilterTemplatesList.addEventListener("click", function (event) {
        const listItem = event.target.closest(".list-group-item");
        if (listItem) {
          // Remove active class from all items
          profileFilterTemplatesList
            .querySelectorAll(".list-group-item")
            .forEach((item) => item.classList.remove("active"));

          // Add active class to the clicked item
          listItem.classList.add("active");
        }
      });
    });
    document.addEventListener("DOMContentLoaded", function () {
      const datasourceSelect = document.getElementById("datasourceSelect");
      const addTriggerEventButton = document.getElementById(
        "addTriggerEventButton"
      );
      const triggerEventTemplatesList = document.getElementById(
        "triggerEventTemplatesList"
      );
      const selectTriggerEventModal = new bootstrap.Modal(
        document.getElementById("selectTriggerEventModal")
      );
      const selectTriggerEventButton = document.getElementById(
        "selectTriggerEventButton"
      );
      const triggerEventContainer = document.getElementById(
        "triggerEventContainer"
      );
      let selectionDict = {}; // Dictionary to store operators and enums for each templateID
      async function fetchOperatorsAndEnumsByTemplateID(templateID) {
        try {
          const response = await fetch(
            `/api/get_operators_and_enums_by_templateID/${templateID}/`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch operators and enums.");
          }

          const data = await response.json();
          if (data.success) {
            console.debug(data);
            selectionDict = data.operators_and_enums;
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error fetching operators and enums:", error);
          alert("Failed to fetch operators and enums.");
        }
      }
      // Function to fetch templates with $feed in their expression
      async function fetchTriggerEventTemplates(datasourceId) {
        try {
          const response = await fetch(
            `/api/event-templates-for-datasource/${datasourceId}/`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch templates.");
          }

          const data = await response.json();
          if (data.success) {
            console.debug(data);
            triggerEventTemplatesList.innerHTML = ""; // Clear existing templates

            // Populate templates in the modal
            data.templates.forEach((template) => {
              if (template.expression.includes("$feed") || template.expression.includes("$aggregation")) {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.dataset.templateId = template.id;
                li.dataset.expression = template.expression;
                li.dataset.displayText = template.display_text;

                li.textContent = template.name;
                triggerEventTemplatesList.appendChild(li);
              }
            });

            selectTriggerEventModal.show(); // Show the modal
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error fetching templates:", error);
          alert("Failed to fetch templates.");
        }
      }

      // Handle "Add Trigger Event" button click
      addTriggerEventButton.addEventListener("click", async function () {
        const selectedDatasourceId = datasourceSelect.value;
        if (!selectedDatasourceId) {
          alert("Please select a datasource first.");
          return;
        }

        await fetchTriggerEventTemplates(selectedDatasourceId);
      });

      // Handle template selection in the modal
      selectTriggerEventButton.addEventListener("click", async function () {
        const selectedTemplate = triggerEventTemplatesList.querySelector(
          ".list-group-item.active"
        );
        if (!selectedTemplate) {
          alert("Please select a template.");
          return;
        }

        const templateID = selectedTemplate.dataset.templateId;
        await fetchOperatorsAndEnumsByTemplateID(templateID);
        const uniqueTriggerId = `trigger_${Date.now()}`; // Generate a unique ID
        const triggerDiv = document.createElement("div");
        triggerDiv.className = "mb-2";
        triggerDiv.dataset.templateId = templateID;
        triggerDiv.dataset.expression = selectedTemplate.dataset.expression;
        triggerDiv.id = uniqueTriggerId; // Assign the unique identifier

        const displayText = selectedTemplate.dataset.displayText;

        // Replace selection placeholders with dropdowns
        const updatedDisplayText = displayText.replace(
          /\$selection\_(\w+)/g,
          function (match, selectionKey) {
            console.debug("Processing selection key:", selectionKey);

            const container = document.createElement("span"); // Use a span to group elements
            container.style.display = "inline-flex"; // Ensure elements appear together
            if (selectionDict[match]) {
              const selectionType = selectionDict[match].type;
              const selectionValue = selectionDict[match].value;

              if (selectionType === "input") {
                // Create an input field for type "input"
                const input = document.createElement("input");
                input.type = selectionDict[match].datatype || "text"; // Use the datatype or default to "text"
                input.className = "form-control form-control-sm me-2";
                input.name = match; // Use the match variable as the name
                input.id = `${uniqueTriggerId}_${match}`; // Create a unique ID using the trigger ID and match
                container.appendChild(input);
                return container.outerHTML; // Return the container's HTML
              } else {
                // Create a dropdown for other types (enum, operator)
                const select = document.createElement("select");
                select.className = "form-select form-select-sm me-2";
                select.style.width = "auto";
                select.name = match; // Use the match variable as the name
                select.id = `${uniqueTriggerId}_${match}`; // Create a unique ID using the trigger ID and match

                for (const option_item of selectionDict[match]["options"]) {
                  const option = document.createElement("option");
                  option.value = option_item.key;
                  option.textContent = option_item.display_name;
                  select.appendChild(option);
                }
                container.appendChild(select);
                return container.outerHTML; // Return the container's HTML
              }
            } else {
              console.warn(
                `No options found for selection key: ${selectionKey}`
              );
              const placeholder = document.createElement("span");
              placeholder.textContent = "No options available";
              container.appendChild(placeholder);
              return container.outerHTML;
            }
          }
        );

        // Add the updated display text to the div
        triggerDiv.innerHTML = updatedDisplayText;

        // Add a delete button to remove the trigger event
        const deleteButton = document.createElement("button");
        deleteButton.className = "btn-close";
        deleteButton.addEventListener("click", function () {
          triggerDiv.remove();
        });

        triggerDiv.appendChild(deleteButton);
        triggerEventContainer.appendChild(triggerDiv);

        // Close the modal
        selectTriggerEventModal.hide();
      });

      // Add click event listener to list items for selection
      triggerEventTemplatesList.addEventListener("click", function (event) {
        const listItem = event.target.closest(".list-group-item");
        if (listItem) {
          // Remove active class from all items
          triggerEventTemplatesList
            .querySelectorAll(".list-group-item")
            .forEach((item) => item.classList.remove("active"));

          // Add active class to the clicked item
          listItem.classList.add("active");
        }
      });
    });
    document.addEventListener("DOMContentLoaded", function () {
      const addTriggerActionButton = document.getElementById("addTriggerActionButton");
      const triggerActionsContainer = document.getElementById("triggerActionsContainer");
      let datasourceSchemaFields = []; // Placeholder for datasource schema fields
      let datastoreSchemas = {}; // Placeholder for related datastore schemas
    
      // Fetch schema fields for datasource and datastores
      async function fetchSchemaFields(datasourceId) {
        try {
          const response = await fetch(`/api/get_schema_fields_for_action/${datasourceId}/`);
          if (!response.ok) {
            throw new Error("Failed to fetch schema fields.");
          }
    
          const data = await response.json();
          if (data.success) {
            datasourceSchemaFields = data.datasource_fields || [];
            datastoreSchemas = data.datastore_schemas || {};
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error fetching schema fields:", error);
          alert("Failed to fetch schema fields.");
        }
      }
    
      // Function to create a trigger action element
      function createTriggerActionElement() {
        const uniqueActionId = `action_${Date.now()}`; // Generate a unique ID
        const actionDiv = document.createElement("div");
        actionDiv.className = "mb-3 border p-3";
        actionDiv.id = uniqueActionId;
    
        // Generate datastore options dynamically
        const datastoreOptions = Object.keys(datastoreSchemas)
          .map(datastoreName => `<optgroup label="${datastoreName}">
            ${datastoreSchemas[datastoreName].map(field => `<option value="${field}">${field}</option>`).join("")}
          </optgroup>`)
          .join("");
    
        actionDiv.innerHTML = `
          <div class="mb-3">
            <label for="${uniqueActionId}_eventIdentifier" class="form-label">Event Identifier</label>
            <input type="text" id="${uniqueActionId}_eventIdentifier" name="eventIdentifier" class="form-control" placeholder="Enter event identifier">
          </div>
          <div class="mb-3">
            <label for="${uniqueActionId}_endpoint" class="form-label">Endpoint</label>
            <select id="${uniqueActionId}_endpoint" name="endpoint" class="form-select select2" multiple>
              <option value="DB">DB</option>
              <option value="Kafka">Kafka</option>
              <option value="Api">Api</option>
            </select>
            
          </div>
          <div class="mb-3">
            <label for="${uniqueActionId}_realtimeAttributes" class="form-label">Realtime Attributes</label>
            <select id="${uniqueActionId}_realtimeAttributes" name="realtimeAttributes" class="form-select select2" multiple>
              ${datasourceSchemaFields.map(field => `<option value="${field}">${field}</option>`).join("")}
            </select>
            
          </div>
          <div class="mb-3">
            <label for="${uniqueActionId}_profileAttributes" class="form-label">Profile Attributes</label>
            <select id="${uniqueActionId}_profileAttributes" name="profileAttributes" class="form-select select2" multiple>
              ${datastoreOptions}
            </select>
            
          </div>
          <button type="button" class="btn btn-danger btn-sm" id="${uniqueActionId}_removeButton">Remove</button>
        `;
    
        // Add functionality to remove the trigger action
        const removeButton = actionDiv.querySelector(`#${uniqueActionId}_removeButton`);
        removeButton.addEventListener("click", function () {
          actionDiv.remove();
        });
    
        // Add functionality to handle dropdowns
        const selects = actionDiv.querySelectorAll("select");
        selects.forEach(select => {
          
          
    
          
    
          // Initialize Select2 for search functionality
          $(select).select2({
            placeholder: "Select an option",
            allowClear: true,
          });
        });
    
        triggerActionsContainer.appendChild(actionDiv);
      }
    
      // Handle "Add Trigger Action" button click
      addTriggerActionButton.addEventListener("click", async function () {
        const datasourceSelect = document.getElementById("datasourceSelect");
        const selectedDatasourceId = datasourceSelect.value;
    
        if (!selectedDatasourceId) {
          alert("Please select a datasource first.");
          return;
        }
    
        // Fetch schema fields if not already fetched
        if (datasourceSchemaFields.length === 0 || Object.keys(datastoreSchemas).length === 0) {
          await fetchSchemaFields(selectedDatasourceId);
        }
    
        createTriggerActionElement();
      });
    });
    document.addEventListener("DOMContentLoaded", function () {
      const profileTemplateContainer = document.getElementById("profileTemplateContainer");
      const addProfileFilterButton = document.getElementById("addProfileFilterButton");
    
      // Function to create a filter block
      function createFilterBlock(type = "OR") {
        const blockId = `block_${Date.now()}`; // Generate a unique ID for the block
        const blockDiv = document.createElement("div");
        blockDiv.className = "filter-block border p-3 mb-3";
        blockDiv.dataset.type = type; // Store the block type (AND/OR)
        blockDiv.id = blockId;
    
        // Add block header
        const headerDiv = document.createElement("div");
        headerDiv.className = "d-flex justify-content-between align-items-center mb-2";
        headerDiv.innerHTML = `
          <strong>${type} </strong>
          <div>
            <button class="btn btn-sm btn-primary me-2" data-action="add-filter"> Filter</button>
            <button class="btn btn-sm btn-success me-2" data-action="add-and-block"> AND </button>
            <button class="btn btn-sm btn-warning" data-action="add-or-block"> OR </button>
          </div>
        `;
        blockDiv.appendChild(headerDiv);
    
        // Add filter container
        const filterContainer = document.createElement("div");
        filterContainer.className = "filter-container";
        blockDiv.appendChild(filterContainer);
    
        // Add functionality to buttons
        headerDiv.querySelectorAll("button").forEach(button => {
          button.addEventListener("click", function () {
            const action = this.dataset.action;
            if (action === "add-filter") {
              createFilter(filterContainer);
            } else if (action === "add-and-block") {
              const andBlock = createFilterBlock("AND");
              filterContainer.appendChild(andBlock);
            } else if (action === "add-or-block") {
              const orBlock = createFilterBlock("OR");
              filterContainer.appendChild(orBlock);
            }
          });
        });
    
        // Add delete button for the block
        const deleteButton = document.createElement("button");
        deleteButton.className = "btn-close";
        deleteButton.style.float = "right";
        deleteButton.addEventListener("click", function () {
          blockDiv.remove();
        });
        blockDiv.appendChild(deleteButton);
    
        return blockDiv;
      }
    
      // Function to create a filter
      function createFilter(container) {
        const filterId = `filter_${Date.now()}`; // Generate a unique ID for the filter
        const filterDiv = document.createElement("div");
        filterDiv.className = "filter-item border p-2 mb-2";
        filterDiv.id = filterId;
    
        // Add filter content
        filterDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <select class="form-select form-select-sm me-2" style="width: auto;">
              <option value="field1">Field 1</option>
              <option value="field2">Field 2</option>
              <option value="field3">Field 3</option>
            </select>
            <select class="form-select form-select-sm me-2" style="width: auto;">
              <option value="equals">Equals</option>
              <option value="not_equals">Not Equals</option>
              <option value="greater_than">Greater Than</option>
              <option value="less_than">Less Than</option>
            </select>
            <input type="text" class="form-control form-control-sm me-2" placeholder="Value" style="width: auto;">
            <button class="btn btn-danger btn-sm">Remove</button>
          </div>
        `;
    
        // Add delete functionality to the filter
        filterDiv.querySelector(".btn-danger").addEventListener("click", function () {
          filterDiv.remove();
        });
    
        container.appendChild(filterDiv);
      }
    
      // Handle "Add Profile Filter" button click
      addProfileFilterButton.addEventListener("click", function () {
        const orBlock = createFilterBlock("OR");
        profileTemplateContainer.appendChild(orBlock);
      });
    });
    document.addEventListener("DOMContentLoaded", async function () {
      const triggerEventContainer = document.getElementById("triggerEventContainer");
      const addTriggerEventButton = document.getElementById("addTriggerEventButton");
      const triggerEventTemplatesList = document.getElementById("triggerEventTemplatesList");
      const selectTriggerEventModal = new bootstrap.Modal(document.getElementById("selectTriggerEventModal"));
      const selectTriggerEventButton = document.getElementById("selectTriggerEventButton");
      let selectionDict = {}; // Dictionary to store operators and enums for each templateID
      let activeBlockContainer = null; // Track the block where the filter should be added
    
      // Function to fetch templates with $feed in their expression
      async function fetchTriggerEventTemplates(datasourceId) {
        try {
          const response = await fetch(`/api/event-templates-for-datasource/${datasourceId}/`);
          if (!response.ok) {
            throw new Error("Failed to fetch templates.");
          }
    
          const data = await response.json();
          if (data.success) {
            console.debug(data);
            triggerEventTemplatesList.innerHTML = ""; // Clear existing templates
    
            // Populate templates in the modal
            data.templates.forEach((template) => {
              if (template.expression.includes("$feed") || template.expression.includes("$aggregation")) {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.dataset.templateId = template.id;
                li.dataset.expression = template.expression;
                li.dataset.displayText = template.display_text;
    
                li.textContent = template.name;
                triggerEventTemplatesList.appendChild(li);
              }
            });
    
            selectTriggerEventModal.show(); // Show the modal
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error fetching templates:", error);
          alert("Failed to fetch templates.");
        }
      }
      async function fetchOperatorsAndEnumsByTemplateID(templateID) {
        try {
          const response = await fetch(
            `/api/get_operators_and_enums_by_templateID/${templateID}/`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch operators and enums.");
          }

          const data = await response.json();
          if (data.success) {
            console.debug(data);
            selectionDict = data.operators_and_enums;
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error fetching operators and enums:", error);
          alert("Failed to fetch operators and enums.");
        }
      }
      // Function to create a trigger block
      function createTriggerBlock(type = "OR") {
        const blockId = `trigger_block_${Date.now()}`; // Generate a unique ID for the block
        const blockDiv = document.createElement("div");
        blockDiv.className = "trigger-block border p-3 mb-3";
        blockDiv.dataset.type = type; // Store the block type (AND/OR)
        blockDiv.id = blockId;
    
        // Add block header
        const headerDiv = document.createElement("div");
        headerDiv.className = "d-flex justify-content-between align-items-center mb-2";
        headerDiv.innerHTML = `
          <strong class="block-type">${type}</strong>
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-secondary dropdown-toggle me-2" type="button" id="${blockId}_dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
              ...
            </button>
            <ul class="dropdown-menu" aria-labelledby="${blockId}_dropdownMenuButton">
              <li><button class="dropdown-item" data-action="add-filter">Add Filter</button></li>
              <li><button class="dropdown-item" data-action="add-and-block">Add AND Block</button></li>
              <li><button class="dropdown-item" data-action="add-or-block">Add OR Block</button></li>
            </ul>
            <button class="btn btn-warning btn-sm ms-2" title="Change Block Type">
              <i class="fas fa-arrows-rotate"></i>
            </button>
            <button class="btn btn-danger btn-sm ms-2" title="Delete Block">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        blockDiv.appendChild(headerDiv);
    
        // Add filter container
        const filterContainer = document.createElement("div");
        filterContainer.className = "filter-container";
        blockDiv.appendChild(filterContainer);
    
        // Add functionality to dropdown items
        headerDiv.querySelectorAll(".dropdown-item").forEach(item => {
          item.addEventListener("click", function () {
            const action = this.dataset.action;
            if (action === "add-filter") {
              activeBlockContainer = filterContainer; // Set the active block container
              const datasourceId = document.getElementById("datasourceSelect").value;
              if (!datasourceId) {
                alert("Please select a datasource first.");
                return;
              }
              fetchTriggerEventTemplates(datasourceId); // Open the modal to select a template
            } else if (action === "add-and-block") {
              const andBlock = createTriggerBlock("AND");
              filterContainer.appendChild(andBlock);
            } else if (action === "add-or-block") {
              const orBlock = createTriggerBlock("OR");
              filterContainer.appendChild(orBlock);
            }
          });
        });
    
        // Add functionality to change block type
        const changeTypeButton = headerDiv.querySelector(".btn-warning");
        changeTypeButton.addEventListener("click", function () {
          const currentType = blockDiv.dataset.type;
          const newType = currentType === "OR" ? "AND" : "OR";
          blockDiv.dataset.type = newType;
          headerDiv.querySelector(".block-type").textContent = newType; // Update the displayed type
        });
    
        // Add delete functionality to the delete button
        const deleteButton = headerDiv.querySelector(".btn-danger");
        deleteButton.addEventListener("click", function () {
          blockDiv.remove();
        });
    
        return blockDiv;
      }
    
      // Handle template selection in the modal
      selectTriggerEventButton.addEventListener("click", async function () {
        const selectedTemplate = triggerEventTemplatesList.querySelector(".list-group-item.active");
        if (!selectedTemplate) {
          alert("Please select a template.");
          return;
        }
    
        const templateID = selectedTemplate.dataset.templateId;
        await fetchOperatorsAndEnumsByTemplateID(templateID);
        const uniqueFilterId = `filter_${Date.now()}`; // Generate a unique ID
        const filterDiv = document.createElement("div");
        filterDiv.className = "trigger-filter-item border p-2 mb-2";
        filterDiv.dataset.templateId = templateID;
        filterDiv.dataset.expression = selectedTemplate.dataset.expression;
        filterDiv.id = uniqueFilterId; // Assign the unique identifier
    
        const displayText = selectedTemplate.dataset.displayText;
    
        // Replace selection placeholders with dropdowns
        const updatedDisplayText = displayText.replace(/\$selection\_(\w+)/g, function (match, selectionKey) {
          console.debug("Processing selection key:", selectionKey);
    
          const container = document.createElement("span"); // Use a span to group elements
          container.style.display = "inline-flex"; // Ensure elements appear together
          if (selectionDict[match]) {
            const selectionType = selectionDict[match].type;
            const selectionValue = selectionDict[match].value;
    
            if (selectionType === "input") {
              // Create an input field for type "input"
              const input = document.createElement("input");
              input.type = selectionDict[match].datatype || "text"; // Use the datatype or default to "text"
              input.className = "form-control form-control-sm me-2";
              input.name = match; // Use the match variable as the name
              input.id = `${uniqueFilterId}_${match}`; // Create a unique ID using the filter ID and match
              container.appendChild(input);
              return container.outerHTML; // Return the container's HTML
            } else {
              // Create a dropdown for other types (enum, operator)
              const select = document.createElement("select");
              select.className = "form-select form-select-sm me-2";
              select.style.width = "auto";
              select.name = match; // Use the match variable as the name
              select.id = `${uniqueFilterId}_${match}`; // Create a unique ID using the filter ID and match
    
              for (const option_item of selectionDict[match]["options"]) {
                const option = document.createElement("option");
                option.value = option_item.key;
                option.textContent = option_item.display_name;
                select.appendChild(option);
              }
              container.appendChild(select);
              return container.outerHTML; // Return the container's HTML
            }
          } else {
            console.warn(`No options found for selection key: ${selectionKey}`);
            const placeholder = document.createElement("span");
            placeholder.textContent = "No options available";
            container.appendChild(placeholder);
            return container.outerHTML;
          }
        });
    
        // Add the updated display text to the div
        filterDiv.innerHTML = updatedDisplayText;
    
        // Add a delete button to remove the filter
        const deleteButton = document.createElement("button");
        deleteButton.className = "btn-close";
        deleteButton.addEventListener("click", function () {
          filterDiv.remove();
        });
    
        filterDiv.appendChild(deleteButton);
        activeBlockContainer.appendChild(filterDiv); // Add the filter to the active block container
        console
        // Close the modal
        selectTriggerEventModal.hide();
      });
    
      // Add click event listener to list items for selection
      triggerEventTemplatesList.addEventListener("click", function (event) {
        const listItem = event.target.closest(".list-group-item");
        if (listItem) {
          // Remove active class from all items
          triggerEventTemplatesList.querySelectorAll(".list-group-item").forEach((item) => item.classList.remove("active"));
    
          // Add active class to the clicked item
          listItem.classList.add("active");
        }
      });
    
      // Handle "Add Trigger Event" button click
      addTriggerEventButton.addEventListener("click", function () {
        const orBlock = createTriggerBlock("OR");
        triggerEventContainer.appendChild(orBlock);
      });
    });
  </script>
  {% endblock %}
</div>
